<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mdrm</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        :root {
            --bg-primary: #0a0a0a;
            --bg-secondary: #0f0f0f;
            --bg-tertiary: #141414;
            --bg-card: #181818;
            --bg-hover: #1f1f1f;
            --bg-input: #0f0f0f;
            --border-color: #252525;
            --border-light: #333;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b0b0;
            --text-muted: #666;
            --accent-primary: #4a7fff;
            --accent-hover: #5a8fff;
            --accent-glow: rgba(74, 127, 255, 0.3);
            --success: #4ade80;
            --success-bg: #1a3a1a;
            --success-border: #2a5a2a;
            --success-glow: rgba(74, 222, 128, 0.3);
            --error: #ff6b6b;
            --error-bg: #3a1a1a;
            --error-border: #5a2a2a;
            --error-glow: rgba(255, 107, 107, 0.3);
            --warning: #ffa94d;
            --warning-bg: #3a2a1a;
            --warning-glow: rgba(255, 169, 77, 0.3);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
        }
        
        html {
            height: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            margin: 0;
            font-size: 14px;
            letter-spacing: 0.01em;
        }
        
        body.resizing {
            user-select: none;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(180deg, #1a1a1a 0%, #141414 100%);
            color: var(--text-primary);
            padding: 1rem 1.5rem;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 100;
        }
        
        .header h1 {
            font-weight: 300;
            letter-spacing: 0.15em;
            margin-bottom: 0.5rem;
            font-size: 1.5rem;
            background: linear-gradient(135deg, #fff 0%, #999 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .header-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
            opacity: 0.8;
        }
        
        /* Container */
        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        /* Divider styles */
        .divider {
            width: 4px;
            background: linear-gradient(180deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.02) 100%);
            cursor: col-resize;
            position: relative;
            flex-shrink: 0;
            transition: all var(--transition-fast);
            opacity: 0.5;
        }
        
        .divider:hover {
            opacity: 1;
            background: linear-gradient(180deg, rgba(74,127,255,0.1) 0%, rgba(74,127,255,0.3) 50%, rgba(74,127,255,0.1) 100%);
            width: 6px;
        }
        
        .divider.dragging {
            background: linear-gradient(180deg, rgba(74,127,255,0.2) 0%, rgba(74,127,255,0.5) 50%, rgba(74,127,255,0.2) 100%);
            width: 6px;
            opacity: 1;
        }
        
        /* Folder Tree Column */
        .folders {
            flex: 0 0 25%;
            min-width: 200px;
            background: var(--bg-tertiary);
            overflow-y: auto;
            overflow-x: hidden;
            outline: none;
            height: 100%;
            position: relative;
        }
        
        .folders:focus-within {
            box-shadow: inset 0 0 0 1px var(--accent-glow);
        }
        
        .folders h3 {
            padding: 1rem 1.25rem;
            background: linear-gradient(180deg, #1f1f1f 0%, #1a1a1a 100%);
            color: var(--text-primary);
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 1px solid var(--border-color);
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            backdrop-filter: blur(5px);
        }
        
        .sort-controls {
            display: flex;
            gap: 0.5rem;
            font-size: 0.75rem;
            text-transform: none;
        }
        
        .sort-option {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            user-select: none;
            color: var(--text-muted);
            transition: all var(--transition-fast);
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid transparent;
        }
        
        .sort-option:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }
        
        .sort-option.active {
            color: var(--accent-primary);
            background: rgba(74, 127, 255, 0.1);
            border-color: rgba(74, 127, 255, 0.3);
        }
        
        .sort-arrows {
            display: flex;
            flex-direction: column;
            font-size: 0.5rem;
            line-height: 0.5;
        }
        
        .sort-arrow {
            opacity: 0.3;
            transition: all var(--transition-fast);
        }
        
        .sort-arrow.active {
            opacity: 1;
            color: var(--accent-primary);
            text-shadow: 0 0 8px var(--accent-glow);
        }
        
        .tree {
            padding: 0.5rem 0;
        }
        
        .tree-item {
            cursor: pointer;
            user-select: none;
            transition: all var(--transition-fast);
        }
        
        .tree-item-content {
            display: flex;
            align-items: center;
            padding: 0.6rem 1.25rem;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }
        
        .tree-item-content::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-primary);
            transform: translateX(-100%);
            transition: transform var(--transition-fast);
        }
        
        .tree-item-content:hover {
            background: var(--bg-hover);
            padding-left: 1.5rem;
        }
        
        .tree-item.selected > .tree-item-content {
            background: linear-gradient(90deg, rgba(74, 127, 255, 0.15) 0%, rgba(74, 127, 255, 0.05) 100%);
            color: var(--text-primary);
        }
        
        .tree-item.selected > .tree-item-content::before {
            transform: translateX(0);
        }
        
        .tree-item.keyboard-focus > .tree-item-content {
            box-shadow: inset 0 0 0 1px var(--accent-primary);
        }
        
        .tree-icon {
            margin-right: 0.75rem;
            font-size: 1.1rem;
            filter: saturate(0.5);
            transition: all var(--transition-fast);
        }
        
        .tree-item:hover .tree-icon {
            filter: saturate(1);
            transform: scale(1.1);
        }
        
        .tree-children {
            display: none;
            animation: slideDown var(--transition-normal);
        }
        
        .tree-children.expanded {
            display: block;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Files Column */
        .files {
            flex: 0 0 35%;
            min-width: 250px;
            background: var(--bg-card);
            overflow-y: auto;
            overflow-x: hidden;
            outline: none;
            height: 100%;
            position: relative;
        }
        
        .files:focus-within {
            box-shadow: inset 0 0 0 1px var(--accent-glow);
        }
        
        .files h3 {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
        
        #file-count {
            font-weight: 400;
            color: var(--text-muted);
            margin-left: 0.5rem;
            font-size: 0.85rem;
        }        

        .files .files-header {
            display: flex;
            justify-content: space-between;
            place-items: center;
            padding: 0.75rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(5px);
            background: linear-gradient(180deg, #1f1f1f 0%, #1a1a1a 100%);
        }

        .files .files-header #filter-box {
            padding-block: 0.5rem;
        }
        
        #file-list {
            list-style: none;
        }
        
        #file-list li {
            padding: 0.9rem 1.25rem;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        #file-list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-primary);
            transform: translateX(-100%);
            transition: transform var(--transition-fast);
        }
        
        #file-list li:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
            padding-left: 1.5rem;
        }
        
        #file-list li.selected {
            background: linear-gradient(90deg, rgba(74, 127, 255, 0.15) 0%, rgba(74, 127, 255, 0.05) 100%);
            color: var(--text-primary);
        }
        
        #file-list li.selected::before {
            transform: translateX(0);
        }
        
        #file-list li.keyboard-focus {
            box-shadow: inset 0 0 0 1px var(--accent-primary);
        }

        #file-list li[aria-hidden="true"] {
            display: none;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-folder {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.35rem;
            opacity: 0.7;
        }
        
        /* Audio playback controls */
        .play-button {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            margin-left: 1rem;
        }
        
        .play-button:hover {
            background: rgba(74, 127, 255, 0.2);
            border-color: rgba(74, 127, 255, 0.4);
            transform: scale(1.1);
        }
        
        .play-button.playing {
            background: rgba(74, 127, 255, 0.3);
            border-color: var(--accent-primary);
        }
        
        #file-list li.selected .play-button {
            display: flex;
        }
        
        .play-icon, .pause-icon {
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .pause-icon {
            display: none;
        }
        
        .play-button.playing .play-icon {
            display: none;
        }
        
        .play-button.playing .pause-icon {
            display: block;
        }
        
        /* Hidden audio element */
        #audio-player {
            display: none;
        }
        
        /* Metadata Column */
        .metadata {
            flex: 1;
            min-width: 300px;
            padding: 2rem 2.5rem;
            background: var(--bg-secondary);
            overflow-y: auto;
            height: 100%;
        }
        
        .metadata h3 {
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            font-weight: 400;
            font-size: 1.1rem;
            letter-spacing: 0.02em;
        }
        
        .filename-display {
            cursor: pointer;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            transition: all var(--transition-fast);
            display: inline-block;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.02);
        }
        
        .filename-display:hover {
            background: rgba(74, 127, 255, 0.1);
            color: var(--accent-primary);
            transform: translateX(4px);
        }
        
        .filename-edit {
            display: none;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            animation: fadeIn var(--transition-normal);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .filename-edit input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }
        
        .filename-edit input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }
        
        .filename-edit button {
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all var(--transition-fast);
        }
        
        .filename-save {
            background: linear-gradient(135deg, #2d5a2d 0%, #3a7a3a 100%);
            color: white;
            min-width: 80px;
        }
        
        .filename-save.processing,
        .filename-save.success,
        .filename-save.error {
            min-width: 120px;
        }
        
        .filename-save:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 45, 0.4);
        }
        
        .filename-reset {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }
        
        .filename-reset:hover {
            background: #2a2a2a;
            color: var(--text-primary);
        }
        
        .filename-cancel {
            background: linear-gradient(135deg, #5a2a2a 0%, #7a3a3a 100%);
            color: white;
            padding: 0.75rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .filename-cancel:hover {
            transform: rotate(90deg);
        }
        
        /* Album Art Section */
        .album-art-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.02) 0%, rgba(255,255,255,0.04) 100%);
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
        }
        
        .album-art-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1.5rem;
        }
        
        .album-art {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.6);
            transition: all var(--transition-normal);
        }
        
        .album-art:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 36px rgba(0,0,0,0.8);
        }
        
        .album-art-placeholder {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 2px dashed rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            transition: all var(--transition-fast);
        }
        
        .album-art-placeholder:hover {
            border-color: rgba(255, 255, 255, 0.2);
            background: linear-gradient(135deg, rgba(255,255,255,0.05) 0%, rgba(255,255,255,0.02) 100%);
        }
        
        .album-art-controls {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            align-items: stretch;
            min-width: 150px;
        }
        
        .album-art-controls button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            width: 100%;
        }
        
        /* Expand album art buttons when showing status */
        .album-art-controls .btn-status.processing,
        .album-art-controls .btn-status.success,
        .album-art-controls .btn-status.error,
        .album-art-controls .btn-status.warning {
            min-width: 220px;
        }
        
        .album-art-controls button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: -1;
        }
        
        .album-art-controls button:hover:not(.processing):not(.success):not(.error):not(.warning)::before {
            width: 300px;
            height: 300px;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
            color: var(--text-primary);
        }
        
        .upload-btn:hover:not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(58, 58, 58, 0.4);
        }
        
        .save-image-btn {
            background: linear-gradient(135deg, #2d5a2d 0%, #3a7a3a 100%);
            color: white;
        }
        
        .save-image-btn:hover:not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 45, 0.4);
        }
        
        .apply-folder-btn {
            background: linear-gradient(135deg, #4a5d7a 0%, #5a6d8a 100%);
            color: white;
        }
        
        .apply-folder-btn:hover:not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 93, 122, 0.4);
        }
        
        .delete-art-btn {
            background: linear-gradient(135deg, #5a2a2a 0%, #7a3a3a 100%);
            color: white;
        }
        
        .delete-art-btn:hover:not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(90, 45, 45, 0.4);
        }
        
        input[type="file"] {
            display: none;
        }
        
        #metadata-form {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .form-group-with-button {
            position: relative;
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }
        
        .form-group-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* New apply field controls styling */
        .apply-field-controls {
            display: none;
            align-items: center;
            gap: 0.5rem;
            height: fit-content;
            margin-bottom: 0;
            animation: slideIn var(--transition-normal);
        }
        
        .apply-field-controls.visible {
            display: flex;
        }
        
        .apply-field-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
            padding-right: 0.25rem;
        }
        
        .apply-field-btn {
            padding: 0.6rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .apply-file-btn {
            background: linear-gradient(135deg, #2d5a2d 0%, #3a7a3a 100%);
            color: white;
        }
        
        .apply-file-btn:hover:not(.processing):not(.success):not(.error):not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 90, 45, 0.4);
        }
        
        .apply-folder-btn-new {
            background: linear-gradient(135deg, #4a5d7a 0%, #5a6d8a 100%);
            color: white;
        }
        
        .apply-folder-btn-new:hover:not(.processing):not(.success):not(.error):not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(74, 93, 122, 0.4);
        }
        
        .apply-field-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .apply-field-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
            z-index: -1;
        }
        
        .apply-field-btn:hover:not(.processing):not(.success):not(.error):not(.warning):not(:disabled)::before {
            width: 200px;
            height: 200px;
        }
        
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        label {
            font-weight: 500;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }
        
        /* Input wrapper for inference loading indicator */
        .input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .inference-loading {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 14px;
            height: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }
        
        .inference-loading.active {
            opacity: 1;
        }
        
        .inference-spinner {
            width: 100%;
            height: 100%;
            border: 2px solid rgba(74, 127, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--accent-primary);
            animation: inference-spin 0.8s ease-in-out infinite;
        }
        
        @keyframes inference-spin {
            to { transform: rotate(360deg); }
        }
        
        input[type="text"] {
            padding: 0.85rem 1rem;
            padding-right: 2.5rem; /* Make room for inference spinner */
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all var(--transition-fast);
            background: var(--bg-input);
            color: var(--text-primary);
            width: 100%;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--accent-primary);
            background: rgba(74, 127, 255, 0.05);
            box-shadow: 0 0 0 3px var(--accent-glow);
            transform: translateY(-1px);
        }
        
        input[type="text"]::placeholder {
            color: var(--text-muted);
            opacity: 0.6;
        }
        
        /* Inference suggestions dropdown */
        .inference-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-fast);
            pointer-events: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .inference-suggestions.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-item:hover {
            background: var(--bg-hover);
            padding-left: 1.25rem;
        }
        
        .suggestion-value {
            flex: 1;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-right: 1rem;
        }
        
        .suggestion-confidence {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        .confidence-bar {
            width: 40px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }
        
        .confidence-fill {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            background: linear-gradient(90deg, var(--accent-primary) 0%, var(--accent-hover) 100%);
            transition: width var(--transition-normal);
            border-radius: 2px;
        }
        
        .confidence-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 35px;
            text-align: right;
        }
        
        .no-suggestions {
            padding: 1rem;
            text-align: center;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        
        .buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        button {
            padding: 0.9rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }
        
        /* Allow overflow for status messages to prevent cutoff */
        .btn-status.processing,
        .btn-status.success,
        .btn-status.error,
        .btn-status.warning {
            overflow: visible;
        }
        
        /* Keep ripple effect contained */
        button::before,
        button::after {
            z-index: -1;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #2d5a2d 0%, #3a7a3a 100%);
            color: white;
            flex: 1;
            min-width: 120px;
        }
        
        .save-btn.processing,
        .save-btn.success,
        .save-btn.error {
            flex: 0 0 auto;
            min-width: 160px;
        }
        
        .save-btn:hover:not(:disabled):not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 90, 45, 0.5);
        }
        
        .clear-btn {
            background: linear-gradient(135deg, #3a3a3a 0%, #4a4a4a 100%);
            color: var(--text-primary);
            min-width: 80px;
        }
        
        .clear-btn.processing,
        .clear-btn.success,
        .clear-btn.error {
            min-width: 120px;
        }
        
        .clear-btn:hover:not(:disabled):not(.processing):not(.success):not(.error):not(.warning) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(58, 58, 58, 0.5);
        }
        
        /* Button Status Styles */
        .btn-status {
            position: relative;
            transition: all var(--transition-normal), width var(--transition-normal), min-width var(--transition-normal);
            min-width: fit-content;
        }
        
        .btn-status-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: opacity var(--transition-fast);
            position: relative;
            z-index: 1;
        }
        
        .btn-status-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            font-size: 0.85rem;
            padding: 0 1rem;
            white-space: nowrap;
            overflow: visible;
            text-overflow: ellipsis;
            z-index: 2;
        }
        
        /* Expand button when showing status */
        .btn-status.processing,
        .btn-status.success,
        .btn-status.error,
        .btn-status.warning {
            min-width: max-content;
            width: auto !important;
        }
        
        /* Prevent apply-field buttons from expanding */
        .apply-field-btn.processing,
        .apply-field-btn.success,
        .apply-field-btn.error,
        .apply-field-btn.warning {
            min-width: initial !important;
            width: auto !important;
        }
        
        .btn-status.processing .btn-status-content,
        .btn-status.success .btn-status-content,
        .btn-status.error .btn-status-content {
            opacity: 0;
        }
        
        .btn-status.processing .btn-status-message,
        .btn-status.success .btn-status-message,
        .btn-status.error .btn-status-message {
            opacity: 1;
        }
        
        /* Processing state */
        .btn-status.processing {
            background: linear-gradient(135deg, #4a5d7a 0%, #5a6d8a 100%) !important;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        /* Success state */
        .btn-status.success {
            background: linear-gradient(135deg, #2d5a2d 0%, #3a7a3a 100%) !important;
            box-shadow: 0 4px 16px var(--success-glow) !important;
        }
        
        /* Error state */
        .btn-status.error {
            background: linear-gradient(135deg, #5a2a2a 0%, #7a3a3a 100%) !important;
            box-shadow: 0 4px 16px var(--error-glow) !important;
        }
        
        /* Warning state */
        .btn-status.warning {
            background: linear-gradient(135deg, #5a4a2a 0%, #7a6a3a 100%) !important;
            box-shadow: 0 4px 16px var(--warning-glow) !important;
        }
        
        /* Status icons */
        .status-icon {
            font-size: 1rem;
            animation: statusIconIn var(--transition-normal);
        }
        
        /* Smaller icons for apply-field buttons */
        .apply-field-btn .status-icon {
            font-size: 0.9rem;
        }
        
        @keyframes statusIconIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        .status-icon.success { color: #4ade80; }
        .status-icon.error { color: #ff6b6b; }
        .status-icon.warning { color: #ffa94d; }
        
        /* Loading spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.2);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s ease-in-out infinite;
        }
        
        /* Smaller spinner for apply-field buttons */
        .apply-field-btn .spinner {
            width: 14px;
            height: 14px;
            border-width: 1.5px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Legacy status (hidden but preserved for compatibility) */
        .status {
            display: none !important;
        }
        
        .no-file-selected {
            text-align: center;
            color: var(--text-muted);
            margin-top: 4rem;
            font-size: 0.95rem;
            opacity: 0.7;
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 12px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.15) 100%);
            border-radius: 6px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.2) 100%);
            background-clip: padding-box;
        }
        
        /* Focus styles for accessibility */
        *:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* Button ripple effect */
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%);
            transform-origin: 50% 50%;
        }
        
        button:focus:not(:active):not(.processing):not(.success):not(.error):not(.warning)::after {
            animation: ripple 1s ease-out;
        }
        
        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 1;
            }
            20% {
                transform: scale(25, 25);
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: scale(40, 40);
            }
        }
        
        /* Disable hover effects during status display */
        .btn-status.processing::before,
        .btn-status.success::before,
        .btn-status.error::before,
        .btn-status.warning::before,
        .btn-status.processing::after,
        .btn-status.success::after,
        .btn-status.error::after,
        .btn-status.warning::after {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><b>metadata</b>&nbsp;<img src="{{ url_for('static', filename='favicon.ico') }}" alt="" style="width: 1.2em; height: 1.2em; vertical-align: middle; display: inline-block;">&nbsp;&nbsp;<b>remote</b></h1>
        <div class="header-hint">Use ↑↓ arrow keys to navigate (auto-loads files), Enter to expand folders, Tab to switch panes</div>
    </div>
    
    <div class="container">
        <div class="folders">
            <h3>
                <span>Folders</span>
                <div class="sort-controls">
                    <div class="sort-option" onclick="setSortMethod('name')" id="sort-name">
                        <span>Name</span>
                        <div class="sort-arrows">
                            <span class="sort-arrow" data-dir="asc">▲</span>
                            <span class="sort-arrow" data-dir="desc">▼</span>
                        </div>
                    </div>
                    <div class="sort-option" onclick="setSortMethod('date')" id="sort-date">
                        <span>Date</span>
                        <div class="sort-arrows">
                            <span class="sort-arrow" data-dir="asc">▲</span>
                            <span class="sort-arrow" data-dir="desc">▼</span>
                        </div>
                    </div>
                </div>
            </h3>
            <div id="folder-tree" class="tree"></div>
        </div>
        
        <div class="divider" id="divider1"></div>
        
        <div class="files">
            <div class="files-header">
                <h3>Files <span id="file-count"></span></h3>
                <div>
                    <input type="text" id="filter-box" placeholder="Type to filter..." />
                </div>
            </div>
            <ul id="file-list"></ul>
        </div>
        
        <div class="divider" id="divider2"></div>
        
        <div class="metadata">
            <div id="no-file-message" class="no-file-selected">
                Select a file to edit its metadata
            </div>
            
            <div id="metadata-section" style="display: none;">
                <h3>Metadata for: <span id="current-filename" class="filename-display"></span></h3>
                
                <div class="filename-edit">
                    <input type="text" id="filename-input" placeholder="Enter new filename">
                    <button class="filename-save btn-status" onclick="saveFilename()">
                        <span class="btn-status-content">Save</span>
                        <span class="btn-status-message"></span>
                    </button>
                    <button class="filename-reset" onclick="resetFilename()">Reset</button>
                    <button class="filename-cancel" onclick="cancelFilenameEdit()">✕</button>
                </div>
                
                <div class="album-art-section">
                    <div class="album-art-container">
                        <div id="art-display">
                            <div class="album-art-placeholder">No album art</div>
                        </div>
                        <div class="album-art-controls">
                            <button class="upload-btn" onclick="document.getElementById('art-upload').click()">Upload Image</button>
                            <button class="save-image-btn btn-status" onclick="saveAlbumArt()" style="display: none;">
                                <span class="btn-status-content">Save Image</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button class="apply-folder-btn btn-status" onclick="applyArtToFolder()" style="display: none;">
                                <span class="btn-status-content">Apply to All in Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button class="delete-art-btn btn-status" onclick="deleteAlbumArt()" style="display: none;">
                                <span class="btn-status-content">Delete Image</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <input type="file" id="art-upload" accept="image/*" onchange="handleArtUpload(event)">
                        </div>
                    </div>
                </div>
                
                <form id="metadata-form">
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="title">Title</label>
                            <div class="input-wrapper">
                                <input type="text" id="title" placeholder="Enter title" data-field="title">
                                <div class="inference-loading" id="title-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="title-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="title">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="title" onclick="saveFieldToFile('title')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="title" onclick="applyFieldToFolder('title')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="artist">Artist</label>
                            <div class="input-wrapper">
                                <input type="text" id="artist" placeholder="Enter artist" data-field="artist">
                                <div class="inference-loading" id="artist-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="artist-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="artist">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="artist" onclick="saveFieldToFile('artist')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="artist" onclick="applyFieldToFolder('artist')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="album">Album</label>
                            <div class="input-wrapper">
                                <input type="text" id="album" placeholder="Enter album" data-field="album">
                                <div class="inference-loading" id="album-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="album-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="album">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="album" onclick="saveFieldToFile('album')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="album" onclick="applyFieldToFolder('album')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="albumartist">Album Artist</label>
                            <div class="input-wrapper">
                                <input type="text" id="albumartist" placeholder="Enter album artist" data-field="albumartist">
                                <div class="inference-loading" id="albumartist-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="albumartist-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="albumartist">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="albumartist" onclick="saveFieldToFile('albumartist')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="albumartist" onclick="applyFieldToFolder('albumartist')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="date">Year</label>
                            <div class="input-wrapper">
                                <input type="text" id="date" placeholder="Enter year" data-field="date">
                                <div class="inference-loading" id="date-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="date-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="date">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="date" onclick="saveFieldToFile('date')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="date" onclick="applyFieldToFolder('date')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="genre">Genre</label>
                            <div class="input-wrapper">
                                <input type="text" id="genre" placeholder="Enter genre" data-field="genre">
                                <div class="inference-loading" id="genre-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="genre-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="genre">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="genre" onclick="saveFieldToFile('genre')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="genre" onclick="applyFieldToFolder('genre')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="track">Track Number</label>
                            <div class="input-wrapper">
                                <input type="text" id="track" placeholder="Enter track number" data-field="track">
                                <div class="inference-loading" id="track-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="track-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="track">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="track" onclick="saveFieldToFile('track')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="track" onclick="applyFieldToFolder('track')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group-with-button">
                        <div class="form-group-wrapper">
                            <label for="disc">CD Number</label>
                            <div class="input-wrapper">
                                <input type="text" id="disc" placeholder="Enter CD number" data-field="disc">
                                <div class="inference-loading" id="disc-loading">
                                    <div class="inference-spinner"></div>
                                </div>
                                <div class="inference-suggestions" id="disc-suggestions"></div>
                            </div>
                        </div>
                        <div class="apply-field-controls" data-field="disc">
                            <span class="apply-field-label">Apply to</span>
                            <button type="button" class="apply-field-btn apply-file-btn btn-status" data-field="disc" onclick="saveFieldToFile('disc')">
                                <span class="btn-status-content">File</span>
                                <span class="btn-status-message"></span>
                            </button>
                            <button type="button" class="apply-field-btn apply-folder-btn-new btn-status" data-field="disc" onclick="applyFieldToFolder('disc')">
                                <span class="btn-status-content">Folder</span>
                                <span class="btn-status-message"></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="buttons">
                        <button type="button" class="save-btn btn-status" onclick="save()">
                            <span class="btn-status-content">Save all fields</span>
                            <span class="btn-status-message"></span>
                        </button>
                        <button type="button" class="clear-btn btn-status" onclick="resetForm()">
                            <span class="btn-status-content">Reset</span>
                            <span class="btn-status-message"></span>
                        </button>
                    </div>
                </form>
                
                <div id="status" class="status"></div>
            </div>
        </div>
    </div>
    
    <!-- Hidden audio player -->
    <audio id="audio-player"></audio>
    
    <script>
        const AudioMetadataEditor = {
            // Centralized state management
            state: {
                currentFile: null,
                currentPath: '',
                selectedListItem: null,
                selectedTreeItem: null,
                originalFilename: '',
                currentAlbumArt: null,
                pendingAlbumArt: null,
                shouldRemoveArt: false,
                treeData: {},
                expandedFolders: new Set(),
                currentSort: { method: 'name', direction: 'asc' },
                focusedPane: 'folders',
                loadFileDebounceTimer: null,
                originalMetadata: {},
                currentlyPlayingFile: null,
                savedPaneSizes: { folders: 25, files: 35 },
                isResizing: false,
                currentDivider: null,
                startX: 0,
                startWidths: {},
                // New inference state
                inferenceActive: {},
                inferenceAbortControllers: {}
            },
        
            // Initialize the application
            init() {
                this.audioPlayer = document.getElementById('audio-player');
                this.setupAudioPlayer();
                this.loadTree();
                this.updateSortUI();
                this.setupKeyboardNavigation();
                this.setupMetadataFieldListeners();
                this.initializePaneResize();
                this.setupInferenceHandlers();
            },
        
            // API helper with centralized error handling
            async apiCall(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error || 'Request failed');
                    }
                    return await response.json();
                } catch (error) {
                    console.error(`API error for ${url}:`, error);
                    throw error;
                }
            },
            
            // Enhanced button status management
            showButtonStatus(button, message, type = 'processing', duration = 3000) {
                if (!button || !button.classList.contains('btn-status')) return;
                
                // Clear any existing timeout
                if (button._statusTimeout) {
                    clearTimeout(button._statusTimeout);
                }
                
                // Store original width if not already stored
                if (!button._originalWidth) {
                    button._originalWidth = window.getComputedStyle(button).width;
                }
                
                // Remove all status classes
                button.classList.remove('processing', 'success', 'error', 'warning');
                
                // Add new status class
                button.classList.add(type);
                
                // Check if this is an apply-field button (File/Folder buttons)
                const isApplyFieldBtn = button.classList.contains('apply-field-btn');
                
                // Truncate very long messages
                const maxLength = 30;
                const displayMessage = message.length > maxLength ? 
                    message.substring(0, maxLength - 3) + '...' : message;
                
                // Update message
                const messageEl = button.querySelector('.btn-status-message');
                if (messageEl) {
                    if (isApplyFieldBtn) {
                        // For File/Folder buttons, show only icons
                        messageEl.textContent = '';
                        if (type === 'processing') {
                            const spinner = document.createElement('span');
                            spinner.className = 'spinner';
                            messageEl.appendChild(spinner);
                        } else {
                            const icons = {
                                success: '✓',
                                error: '✕',
                                warning: '⚠'
                            };
                            const iconSpan = document.createElement('span');
                            iconSpan.className = `status-icon ${type}`;
                            iconSpan.textContent = icons[type] || '';
                            messageEl.appendChild(iconSpan);
                        }
                        // Add tooltip with the actual message
                        button.title = message;
                    } else {
                        // For other buttons, show icon + text as before
                        if (type === 'processing') {
                            messageEl.textContent = '';
                            const spinner = document.createElement('span');
                            spinner.className = 'spinner';
                            messageEl.appendChild(spinner);
                            messageEl.appendChild(document.createTextNode(' ' + displayMessage));
                        } else {
                            const icons = {
                                success: '✓',
                                error: '✕',
                                warning: '⚠'
                            };
                            messageEl.textContent = '';
                            const iconSpan = document.createElement('span');
                            iconSpan.className = `status-icon ${type}`;
                            iconSpan.textContent = icons[type] || '';
                            messageEl.appendChild(iconSpan);
                            messageEl.appendChild(document.createTextNode(' ' + displayMessage));
                        }
                        
                        // Add title attribute for full message if truncated
                        if (message.length > maxLength) {
                            button.title = message;
                        }
                    }
                }
                
                // Auto-clear status after duration (except for processing)
                if (type !== 'processing' && duration > 0) {
                    button._statusTimeout = setTimeout(() => {
                        this.clearButtonStatus(button);
                    }, duration);
                }
            },
            
            clearButtonStatus(button) {
                if (!button || !button.classList.contains('btn-status')) return;
                
                if (button._statusTimeout) {
                    clearTimeout(button._statusTimeout);
                    delete button._statusTimeout;
                }
                
                button.classList.remove('processing', 'success', 'error', 'warning');
                button.title = ''; // Clear tooltip
                
                // Don't restore width for apply-field buttons
                if (!button.classList.contains('apply-field-btn') && button._originalWidth) {
                    setTimeout(() => {
                        button.style.width = '';
                        delete button._originalWidth;
                    }, 300);
                }
            },
        
            // Audio player setup and controls
            setupAudioPlayer() {
                this.audioPlayer.addEventListener('ended', () => this.stopPlayback());
                this.audioPlayer.addEventListener('error', (e) => {
                    // Only show error if we're actually trying to play something
                    if (this.state.currentlyPlayingFile && this.audioPlayer.src) {
                        console.error('Audio playback error:', e);
                        this.stopPlayback();
                        this.showStatus('Error playing audio file', 'error');
                    }
                });
            },
        
            togglePlayback(filepath, button) {
                if (this.state.currentlyPlayingFile === filepath && !this.audioPlayer.paused) {
                    this.audioPlayer.pause();
                    button.classList.remove('playing');
                } else {
                    this.stopPlayback();
                    this.state.currentlyPlayingFile = filepath;
                    this.audioPlayer.src = `/stream/${encodeURIComponent(filepath)}`;
                    this.audioPlayer.play()
                        .then(() => button.classList.add('playing'))
                        .catch(err => {
                            console.error('Error playing audio:', err);
                            this.showStatus('Error playing audio file', 'error');
                            this.stopPlayback();
                        });
                }
            },
        
            stopPlayback() {
                if (!this.audioPlayer.paused) {
                    this.audioPlayer.pause();
                }
                this.audioPlayer.src = '';
                this.state.currentlyPlayingFile = null;
                document.querySelectorAll('.play-button.playing').forEach(btn => {
                    btn.classList.remove('playing');
                });
            },
        
            // Pane resize functionality
            initializePaneResize() {
                const container = document.querySelector('.container');
                const folders = document.querySelector('.folders');
                const files = document.querySelector('.files');
                const metadata = document.querySelector('.metadata');
                const divider1 = document.getElementById('divider1');
                const divider2 = document.getElementById('divider2');
        
                // Apply saved or default sizes
                folders.style.flex = `0 0 ${this.state.savedPaneSizes.folders}%`;
                files.style.flex = `0 0 ${this.state.savedPaneSizes.files}%`;
                metadata.style.flex = `1`;
        
                divider1.addEventListener('mousedown', (e) => this.startResize(e, 'divider1'));
                divider2.addEventListener('mousedown', (e) => this.startResize(e, 'divider2'));
            },
        
            startResize(e, dividerId) {
                const container = document.querySelector('.container');
                const folders = document.querySelector('.folders');
                const files = document.querySelector('.files');
                const metadata = document.querySelector('.metadata');
        
                this.state.isResizing = true;
                this.state.currentDivider = dividerId;
                this.state.startX = e.clientX;
        
                const containerWidth = container.offsetWidth;
                this.state.startWidths.folders = (folders.offsetWidth / containerWidth) * 100;
                this.state.startWidths.files = (files.offsetWidth / containerWidth) * 100;
                this.state.startWidths.metadata = (metadata.offsetWidth / containerWidth) * 100;
        
                document.getElementById(dividerId).classList.add('dragging');
                document.body.style.userSelect = 'none';
                document.body.style.cursor = 'col-resize';
        
                document.addEventListener('mousemove', this.handleResize.bind(this));
                document.addEventListener('mouseup', this.stopResize.bind(this));
            },
        
            handleResize(e) {
                if (!this.state.isResizing) return;
        
                const container = document.querySelector('.container');
                const folders = document.querySelector('.folders');
                const files = document.querySelector('.files');
        
                const containerWidth = container.offsetWidth;
                const deltaX = e.clientX - this.state.startX;
                const deltaPercent = (deltaX / containerWidth) * 100;
        
                if (this.state.currentDivider === 'divider1') {
                    const newFoldersWidth = Math.max(15, Math.min(40, this.state.startWidths.folders + deltaPercent));
                    const newFilesWidth = Math.max(20, Math.min(50, this.state.startWidths.files - deltaPercent));
                    
                    folders.style.flex = `0 0 ${newFoldersWidth}%`;
                    files.style.flex = `0 0 ${newFilesWidth}%`;
                } else if (this.state.currentDivider === 'divider2') {
                    const newFilesWidth = Math.max(20, Math.min(50, this.state.startWidths.files + deltaPercent));
                    const remainingWidth = 100 - this.state.startWidths.folders - newFilesWidth;
                    
                    if (remainingWidth >= 30) {
                        files.style.flex = `0 0 ${newFilesWidth}%`;
                    }
                }
            },
        
            stopResize() {
                if (!this.state.isResizing) return;
        
                this.state.isResizing = false;
        
                if (this.state.currentDivider) {
                    document.getElementById(this.state.currentDivider).classList.remove('dragging');
                }
        
                document.body.style.userSelect = '';
                document.body.style.cursor = '';
        
                const container = document.querySelector('.container');
                const folders = document.querySelector('.folders');
                const files = document.querySelector('.files');
                const containerWidth = container.offsetWidth;
                this.state.savedPaneSizes.folders = (folders.offsetWidth / containerWidth) * 100;
                this.state.savedPaneSizes.files = (files.offsetWidth / containerWidth) * 100;
        
                document.removeEventListener('mousemove', this.handleResize.bind(this));
                document.removeEventListener('mouseup', this.stopResize.bind(this));
        
                this.state.currentDivider = null;
            },
        
            // Metadata field listeners
            setupMetadataFieldListeners() {
                const fields = ['title', 'artist', 'album', 'albumartist', 'date', 'genre', 'track', 'disc'];
                
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    const controls = document.querySelector(`.apply-field-controls[data-field="${field}"]`);
                    
                    const updateControlsVisibility = () => {
                        const hasValue = input.value.trim().length > 0;
                        const hasChanged = input.value !== (this.state.originalMetadata[field] || '');
                        
                        if (hasValue && hasChanged) {
                            controls.classList.add('visible');
                        } else {
                            controls.classList.remove('visible');
                        }
                    };
                    
                    input.addEventListener('input', updateControlsVisibility);
                    input.addEventListener('focus', updateControlsVisibility);
                });
            },
            
            // NEW: Save individual field to file
            async saveFieldToFile(field) {
                if (!this.state.currentFile) return;
                
                const button = document.querySelector(`.apply-file-btn[data-field="${field}"]`);
                const value = document.getElementById(field).value.trim();
                if (!value && value !== '') return; // Allow empty string to clear field
                
                button.disabled = true;
                this.showButtonStatus(button, 'Saving to file...', 'processing');
                
                // Create metadata object with only this field
                const data = {};
                data[field] = value;
                
                try {
                    const result = await this.apiCall(`/metadata/${encodeURIComponent(this.state.currentFile)}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    
                    if (result.status === 'success') {
                        this.showButtonStatus(button, 'Saved to file!', 'success', 2000);
                        this.state.originalMetadata[field] = value;
                        
                        // Hide controls after successful save
                        setTimeout(() => {
                            const controls = document.querySelector(`.apply-field-controls[data-field="${field}"]`);
                            controls.classList.remove('visible');
                        }, 1000);
                    } else {
                        this.showButtonStatus(button, 'Failed to save', 'error');
                    }
                } catch (err) {
                    console.error(`Error saving ${field} to file:`, err);
                    this.showButtonStatus(button, 'Error saving field', 'error');
                }
                
                button.disabled = false;
            },
            
            // NEW: Setup inference handlers
            setupInferenceHandlers() {
                const fields = ['title', 'artist', 'album', 'albumartist', 'date', 'genre', 'track', 'disc'];
                
                fields.forEach(field => {
                    const input = document.getElementById(field);
                    const suggestions = document.getElementById(`${field}-suggestions`);
                    
                    // Click handler for empty fields
                    input.addEventListener('click', (e) => {
                        if (input.value.trim() === '' && !input.disabled && this.state.currentFile) {
                            this.showInferenceSuggestions(field);
                        }
                    });
                    
                    // Input handler to hide suggestions when typing
                    input.addEventListener('input', (e) => {
                        this.hideInferenceSuggestions(field);
                    });
                    
                    // Click outside to hide suggestions
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest(`#${field}`) && !e.target.closest(`#${field}-suggestions`)) {
                            this.hideInferenceSuggestions(field);
                        }
                    });
                });
            },
            
            // NEW: Show inference suggestions
            async showInferenceSuggestions(field) {
                if (this.state.inferenceActive[field]) return;
                
                const loading = document.getElementById(`${field}-loading`);
                const suggestions = document.getElementById(`${field}-suggestions`);
                
                // Cancel any existing request
                if (this.state.inferenceAbortControllers[field]) {
                    this.state.inferenceAbortControllers[field].abort();
                }
                
                // Create new abort controller
                const abortController = new AbortController();
                this.state.inferenceAbortControllers[field] = abortController;
                
                // Show loading
                loading.classList.add('active');
                this.state.inferenceActive[field] = true;
                
                try {
                    const response = await fetch(`/infer/${encodeURIComponent(this.state.currentFile)}/${field}`, {
                        signal: abortController.signal
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to get suggestions');
                    }
                    
                    const data = await response.json();
                    
                    // Hide loading
                    loading.classList.remove('active');
                    
                    // Display suggestions if still active
                    if (this.state.inferenceActive[field]) {
                        this.displaySuggestions(field, data.suggestions);
                    }
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error(`Error getting suggestions for ${field}:`, error);
                        loading.classList.remove('active');
                        
                        // Show error state
                        suggestions.innerHTML = '<div class="no-suggestions">Error loading suggestions</div>';
                        suggestions.classList.add('active');
                        
                        setTimeout(() => {
                            this.hideInferenceSuggestions(field);
                        }, 2000);
                    }
                }
                
                this.state.inferenceActive[field] = false;
            },
            
            // NEW: Display suggestions
            displaySuggestions(field, suggestions) {
                const container = document.getElementById(`${field}-suggestions`);
                container.innerHTML = '';
                
                if (!suggestions || suggestions.length === 0) {
                    container.innerHTML = '<div class="no-suggestions">No suggestions available</div>';
                } else {
                    suggestions.forEach(suggestion => {
                        const item = document.createElement('div');
                        item.className = 'suggestion-item';
                        
                        const value = document.createElement('div');
                        value.className = 'suggestion-value';
                        value.textContent = suggestion.value;
                        
                        const confidence = document.createElement('div');
                        confidence.className = 'suggestion-confidence';
                        
                        const bar = document.createElement('div');
                        bar.className = 'confidence-bar';
                        
                        const fill = document.createElement('div');
                        fill.className = 'confidence-fill';
                        fill.style.width = `${suggestion.confidence}%`;
                        
                        bar.appendChild(fill);
                        
                        const text = document.createElement('div');
                        text.className = 'confidence-text';
                        text.textContent = `${suggestion.confidence}%`;
                        
                        confidence.appendChild(bar);
                        confidence.appendChild(text);
                        
                        item.appendChild(value);
                        item.appendChild(confidence);
                        
                        // Click handler
                        item.addEventListener('click', () => {
                            document.getElementById(field).value = suggestion.value;
                            this.hideInferenceSuggestions(field);
                            
                            // Trigger input event to update apply controls
                            const event = new Event('input', { bubbles: true });
                            document.getElementById(field).dispatchEvent(event);
                        });
                        
                        container.appendChild(item);
                    });
                }
                
                container.classList.add('active');
            },
            
            // NEW: Hide inference suggestions
            hideInferenceSuggestions(field) {
                const loading = document.getElementById(`${field}-loading`);
                const suggestions = document.getElementById(`${field}-suggestions`);
                
                // Cancel any ongoing request
                if (this.state.inferenceAbortControllers[field]) {
                    this.state.inferenceAbortControllers[field].abort();
                    delete this.state.inferenceAbortControllers[field];
                }
                
                loading.classList.remove('active');
                suggestions.classList.remove('active');
                this.state.inferenceActive[field] = false;
            },
        
            // Keyboard navigation
            setupKeyboardNavigation() {
                // Pane click handlers
                document.querySelector('.folders').addEventListener('click', (e) => {
                    this.state.focusedPane = 'folders';
                    this.updatePaneFocus();
                    document.querySelectorAll('.keyboard-focus').forEach(el => {
                        el.classList.remove('keyboard-focus');
                    });
                });
                
                document.querySelector('.files').addEventListener('click', (e) => {
                    this.state.focusedPane = 'files';
                    this.updatePaneFocus();
                    document.querySelectorAll('.keyboard-focus').forEach(el => {
                        el.classList.remove('keyboard-focus');
                    });
                    if (this.state.loadFileDebounceTimer) {
                        clearTimeout(this.state.loadFileDebounceTimer);
                    }
                });
                
                this.updatePaneFocus();
                
                // Global keyboard handler
                document.addEventListener('keydown', (e) => {
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                        return;
                    }
                    
                    if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        this.navigateWithArrows(e.key === 'ArrowUp' ? 'up' : 'down');
                    } else if (e.key === 'Enter') {
                        e.preventDefault();
                        this.activateCurrentItem();
                    } else if (e.key === 'Tab') {
                        e.preventDefault();
                        this.state.focusedPane = this.state.focusedPane === 'folders' ? 'files' : 'folders';
                        this.updatePaneFocus();
                    }
                });
            },
        
            updatePaneFocus() {
                // Visual focus indicator handled by CSS :focus-within
            },
        
            navigateWithArrows(direction) {
                if (this.state.focusedPane === 'folders') {
                    this.navigateFolders(direction);
                } else if (this.state.focusedPane === 'files') {
                    this.navigateFiles(direction);
                }
            },
        
            navigateFolders(direction) {
                const visibleFolders = this.getVisibleFolders();
                if (visibleFolders.length === 0) return;
                
                let currentIndex = -1;
                if (this.state.selectedTreeItem) {
                    currentIndex = visibleFolders.findIndex(item => item === this.state.selectedTreeItem);
                }
                
                let newIndex;
                if (currentIndex === -1) {
                    newIndex = direction === 'up' ? visibleFolders.length - 1 : 0;
                } else if (direction === 'up') {
                    newIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                } else {
                    newIndex = currentIndex < visibleFolders.length - 1 ? currentIndex + 1 : visibleFolders.length - 1;
                }
                
                if (visibleFolders[newIndex]) {
                    this.selectTreeItem(visibleFolders[newIndex], true);
                    visibleFolders[newIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            },
        
            navigateFiles(direction) {
                const fileItems = Array.from(document.querySelectorAll('#file-list li'));
                if (fileItems.length === 0) return;
                
                let currentIndex = -1;
                if (this.state.selectedListItem) {
                    currentIndex = fileItems.findIndex(item => item === this.state.selectedListItem);
                }
                
                let newIndex;
                if (currentIndex === -1) {
                    newIndex = direction === 'up' ? fileItems.length - 1 : 0;
                } else if (direction === 'up') {
                    newIndex = currentIndex > 0 ? currentIndex - 1 : 0;
                } else {
                    newIndex = currentIndex < fileItems.length - 1 ? currentIndex + 1 : fileItems.length - 1;
                }
                
                if (fileItems[newIndex]) {
                    this.selectFileItem(fileItems[newIndex], true);
                    fileItems[newIndex].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                }
            },
        
            getVisibleFolders() {
                const folders = [];
                
                const collectVisible = (container) => {
                    const items = container.children;
                    for (let item of items) {
                        if (item.classList.contains('tree-item')) {
                            folders.push(item);
                            const children = item.querySelector('.tree-children');
                            if (children && children.classList.contains('expanded')) {
                                collectVisible(children);
                            }
                        }
                    }
                };
                
                collectVisible(document.getElementById('folder-tree'));
                return folders;
            },
        
            selectTreeItem(item, isKeyboard = false) {
                if (this.state.selectedTreeItem) {
                    this.state.selectedTreeItem.classList.remove('selected', 'keyboard-focus');
                }
                item.classList.add('selected');
                if (isKeyboard) {
                    item.classList.add('keyboard-focus');
                }
                this.state.selectedTreeItem = item;
                this.state.focusedPane = 'folders';
                this.updatePaneFocus();
            },
        
            selectFileItem(item, isKeyboard = false) {
                if (this.state.selectedListItem) {
                    this.state.selectedListItem.classList.remove('selected', 'keyboard-focus');
                }
                item.classList.add('selected');
                if (isKeyboard) {
                    item.classList.add('keyboard-focus');
                    
                    if (this.state.loadFileDebounceTimer) {
                        clearTimeout(this.state.loadFileDebounceTimer);
                    }
                    
                    const filepath = item.dataset.filepath;
                    if (filepath) {
                        this.state.loadFileDebounceTimer = setTimeout(() => {
                            this.loadFile(filepath, item);
                        }, 150);
                    }
                }
                this.state.selectedListItem = item;
                this.state.focusedPane = 'files';
                this.updatePaneFocus();
            },
        
            activateCurrentItem() {
                if (this.state.focusedPane === 'folders' && this.state.selectedTreeItem) {
                    const content = this.state.selectedTreeItem.querySelector('.tree-item-content');
                    if (content) {
                        content.click();
                    }
                } else if (this.state.focusedPane === 'files' && this.state.selectedListItem) {
                    const filepath = this.state.selectedListItem.dataset.filepath;
                    if (filepath) {
                        this.loadFile(filepath, this.state.selectedListItem);
                    }
                }
            },
        
            // Sorting functionality
            updateSortUI() {
                document.querySelectorAll('.sort-option').forEach(opt => {
                    opt.classList.remove('active');
                    opt.querySelectorAll('.sort-arrow').forEach(arrow => {
                        arrow.classList.remove('active');
                    });
                });
                
                const activeOption = document.getElementById(`sort-${this.state.currentSort.method}`);
                activeOption.classList.add('active');
                activeOption.querySelector(`.sort-arrow[data-dir="${this.state.currentSort.direction}"]`).classList.add('active');
            },
        
            setSortMethod(method) {
                if (this.state.currentSort.method === method) {
                    this.state.currentSort.direction = this.state.currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.state.currentSort.method = method;
                    this.state.currentSort.direction = 'asc';
                }
                
                this.updateSortUI();
                this.rebuildTree();
            },
        
            sortItems(items) {
                return items.sort((a, b) => {
                    let comparison = 0;
                    
                    if (this.state.currentSort.method === 'name') {
                        comparison = a.name.toLowerCase().localeCompare(b.name.toLowerCase());
                    } else if (this.state.currentSort.method === 'date') {
                        comparison = (a.created || 0) - (b.created || 0);
                    }
                    
                    return this.state.currentSort.direction === 'asc' ? comparison : -comparison;
                });
            },
        
            // Tree functionality
            async loadTree() {
                try {
                    const data = await this.apiCall('/tree/');
                    this.state.treeData[''] = data.items;
                    this.buildTreeFromData();
                } catch (err) {
                    console.error('Error loading tree:', err);
                    this.showStatus('Error loading folders', 'error');
                }
            },
        
            buildTreeFromData() {
                const tree = document.getElementById('folder-tree');
                tree.innerHTML = '';
                
                const sortedItems = this.sortItems(this.state.treeData[''] || []);
                
                sortedItems.forEach(item => {
                    if (item.type === 'folder') {
                        tree.appendChild(this.createTreeItem(item, 0));
                    }
                });
            },
        
            rebuildTree() {
                this.buildTreeFromData();
                
                this.state.expandedFolders.forEach(path => {
                    const element = document.querySelector(`[data-path="${path}"]`);
                    if (element && this.state.treeData[path]) {
                        const children = element.querySelector('.tree-children');
                        if (children && this.state.treeData[path].length > 0) {
                            this.rebuildChildren(path, children, this.getLevel(path) + 1);
                            children.classList.add('expanded');
                        }
                    }
                });
                
                if (this.state.selectedTreeItem) {
                    const path = this.state.selectedTreeItem.dataset.path;
                    const newSelected = document.querySelector(`[data-path="${path}"]`);
                    if (newSelected) {
                        newSelected.classList.add('selected');
                        this.state.selectedTreeItem = newSelected;
                    }
                }
            },
        
            getLevel(path) {
                return path ? path.split('/').length - 1 : 0;
            },
        
            rebuildChildren(path, container, level) {
                container.innerHTML = '';
                const sortedItems = this.sortItems(this.state.treeData[path] || []);
                
                sortedItems.forEach(item => {
                    if (item.type === 'folder') {
                        container.appendChild(this.createTreeItem(item, level));
                    }
                });
            },
        
            createTreeItem(item, level) {
                const div = document.createElement('div');
                div.className = 'tree-item';
                div.dataset.path = item.path;
                
                const content = document.createElement('div');
                content.className = 'tree-item-content';
                content.style.paddingLeft = `${level * 1.5 + 1.25}rem`;
                
                const icon = document.createElement('span');
                icon.className = 'tree-icon';
                icon.innerHTML = this.state.expandedFolders.has(item.path) ? '📂' : '📁';
                
                const name = document.createElement('span');
                name.textContent = item.name;
                
                content.appendChild(icon);
                content.appendChild(name);
                
                const children = document.createElement('div');
                children.className = 'tree-children';
                
                div.appendChild(content);
                div.appendChild(children);
                
                content.onclick = (e) => {
                    e.stopPropagation();
                    this.selectTreeItem(div);
                    
                    const isExpanded = children.classList.contains('expanded');
                    
                    if (!isExpanded) {
                        if (children.children.length === 0) {
                            this.loadTreeChildren(item.path, children, level + 1);
                        }
                        children.classList.add('expanded');
                        this.state.expandedFolders.add(item.path);
                        icon.innerHTML = '📂';
                    } else {
                        children.classList.remove('expanded');
                        this.state.expandedFolders.delete(item.path);
                        icon.innerHTML = '📁';
                    }
                    
                    this.loadFiles(item.path);
                };
                
                if (this.state.treeData[item.path] && this.state.treeData[item.path].length > 0 && this.state.expandedFolders.has(item.path)) {
                    const sortedItems = this.sortItems(this.state.treeData[item.path]);
                    sortedItems.forEach(child => {
                        if (child.type === 'folder') {
                            children.appendChild(this.createTreeItem(child, level + 1));
                        }
                    });
                    children.classList.add('expanded');
                    icon.innerHTML = '📂';
                }
                
                return div;
            },
        
            async loadTreeChildren(path, container, level) {
                try {
                    const data = await this.apiCall(`/tree/${encodeURIComponent(path)}`);
                    this.state.treeData[path] = data.items;
                    
                    const sortedItems = this.sortItems(data.items);
                    
                    sortedItems.forEach(item => {
                        if (item.type === 'folder') {
                            container.appendChild(this.createTreeItem(item, level));
                        }
                    });
                } catch (err) {
                    console.error('Error loading tree children:', err);
                }
            },
        
            // File operations
            async loadFiles(folderPath) {
                this.state.currentPath = folderPath;
                document.getElementById('file-count').textContent = '(loading...)';
                
                this.stopPlayback();
                
                try {
                    const data = await this.apiCall(`/files/${encodeURIComponent(folderPath)}`);
                    const list = document.getElementById('file-list');
                    list.innerHTML = '';
                    
                    document.getElementById('file-count').textContent = `(${data.files.length})`;
                    
                    if (data.files.length === 0) {
                        const li = document.createElement('li');
                        li.textContent = 'No audio files found';
                        li.style.color = '#999';
                        li.style.cursor = 'default';
                        list.appendChild(li);
                        return;
                    }

                    const filter_value = document.getElementById('filter-box').value.toLowerCase().trim();
                    
                    data.files.forEach(file => {
                        const li = document.createElement('li');
                        li.dataset.filepath = file.path;

                        if (filter_value.length > 0 && !file.name.toLowerCase().includes(filter_value)) {
                            li.setAttribute("aria-hidden", "true");
                        }
                        
                        const fileInfo = document.createElement('div');
                        fileInfo.className = 'file-info';
                        
                        const nameDiv = document.createElement('div');
                        const formatEmoji = this.getFormatEmoji(file.name);  // Add 'this.'
                        const musicIcon = document.createTextNode(formatEmoji + ' ');
                        nameDiv.appendChild(musicIcon);
                        nameDiv.appendChild(document.createTextNode(file.name));
                        
                        // Add format badge
                        const badgeHtml = this.getFormatBadge(file.name);
                        nameDiv.insertAdjacentHTML('beforeend', badgeHtml);
                        
                        fileInfo.appendChild(nameDiv);
                        
                        if (file.folder !== '.') {
                            const folderDiv = document.createElement('div');
                            folderDiv.className = 'file-folder';
                            folderDiv.textContent = file.folder;
                            fileInfo.appendChild(folderDiv);
                        }
                        
                        li.appendChild(fileInfo);
                        
                        const playButton = document.createElement('div');
                        playButton.className = 'play-button';
                        playButton.innerHTML = '<span class="play-icon">▶</span><span class="pause-icon">❚❚</span>';
                        playButton.onclick = (e) => {
                            e.stopPropagation();
                            this.togglePlayback(file.path, playButton);
                        };
                        li.appendChild(playButton);
                        
                        li.onclick = (e) => {
                            if (!e.target.closest('.play-button')) {
                                this.loadFile(file.path, li);
                            }
                        };
                        list.appendChild(li);
                    });
                } catch (err) {
                    console.error('Error loading files:', err);
                    this.showStatus('Error loading files', 'error');
                    document.getElementById('file-count').textContent = '(error)';
                }
            },
        
            async loadFile(filepath, listItem) {
                
                // Stop any current playback when selecting a different file
                this.stopPlayback();
                
                // Hide all inference suggestions
                const fields = ['title', 'artist', 'album', 'albumartist', 'date', 'genre', 'track', 'disc'];
                fields.forEach(field => this.hideInferenceSuggestions(field));
                
                if (this.state.loadFileDebounceTimer) {
                    clearTimeout(this.state.loadFileDebounceTimer);
                    this.state.loadFileDebounceTimer = null;
                }
                
                this.selectFileItem(listItem);
                
                this.state.currentFile = filepath;
                this.state.originalFilename = filepath.split('/').pop();
                document.getElementById('current-filename').textContent = this.state.originalFilename;
                document.getElementById('no-file-message').style.display = 'none';
                document.getElementById('metadata-section').style.display = 'block';
                
                this.cancelFilenameEdit();
                this.hideStatus();
                
                document.querySelectorAll('.apply-field-controls').forEach(controls => {
                    controls.classList.remove('visible');
                });
                
                if (listItem.classList.contains('keyboard-focus')) {
                    this.showStatus('Loading metadata...', 'success');
                }
                
                this.state.currentAlbumArt = null;
                this.state.pendingAlbumArt = null;
                this.state.shouldRemoveArt = false;
                
                this.setFormEnabled(false);
                
                try {
                    const data = await this.apiCall(`/metadata/${encodeURIComponent(filepath)}`);
                    
                    this.state.originalMetadata = {
                        title: data.title || '',
                        artist: data.artist || '',
                        album: data.album || '',
                        albumartist: data.albumartist || '',
                        date: data.date || '',
                        genre: data.genre || '',
                        track: data.track || '',
                        disc: data.disc || ''
                    };
                    
                    Object.entries(this.state.originalMetadata).forEach(([field, value]) => {
                        document.getElementById(field).value = value;
                    });
                    
                    // Handle format limitations
                    const formatLimitations = data.formatLimitations || {};
                    const format = data.format || '';
                    
                    // Show format-specific warnings
                    if (formatLimitations.hasLimitedMetadata) {
                        this.showStatus(`Note: ${format.toUpperCase()} files have limited metadata support`, 'warning');
                        
                        // Disable unsupported fields
                        if (data.supportedFields) {
                            const allFields = ['title', 'artist', 'album', 'albumartist', 'date', 'genre', 'track', 'disc'];
                            allFields.forEach(field => {
                                const input = document.getElementById(field);
                                const controls = document.querySelector(`.apply-field-controls[data-field="${field}"]`);
                                if (!data.supportedFields.includes(field)) {
                                    input.disabled = true;
                                    input.style.opacity = '0.5';
                                    input.title = `${format.toUpperCase()} format does not support this field`;
                                    if (controls) {
                                        controls.style.display = 'none';
                                    }
                                } else {
                                    input.disabled = false;
                                    input.style.opacity = '1';
                                    input.title = '';
                                    if (controls) {
                                        controls.style.display = '';
                                    }
                                }
                            });
                        }
                    }
                    
                    // Handle album art
                    const artDisplay = document.getElementById('art-display');
                    const deleteBtn = document.querySelector('.delete-art-btn');
                    const saveImageBtn = document.querySelector('.save-image-btn');
                    const applyFolderBtn = document.querySelector('.apply-folder-btn');
                    const uploadBtn = document.querySelector('.upload-btn');
                    
                    // Check if format supports album art
                    if (!formatLimitations.supportsAlbumArt) {
                        artDisplay.innerHTML = `<div class="album-art-placeholder" style="opacity: 0.5;">Album art not supported for ${format.toUpperCase()}</div>`;
                        deleteBtn.style.display = 'none';
                        saveImageBtn.style.display = 'none';
                        applyFolderBtn.style.display = 'none';
                        uploadBtn.disabled = true;
                        uploadBtn.style.opacity = '0.5';
                        uploadBtn.title = `${format.toUpperCase()} format does not support embedded album art`;
                    } else {
                        uploadBtn.disabled = false;
                        uploadBtn.style.opacity = '1';
                        uploadBtn.title = '';
                        
                        if (data.hasArt && data.art) {
                            this.state.currentAlbumArt = data.art;
                            artDisplay.innerHTML = `<img src="data:image/jpeg;base64,${data.art}" class="album-art">`;
                            deleteBtn.style.display = 'block';
                            saveImageBtn.style.display = 'none';
                            applyFolderBtn.style.display = 'none';
                        } else {
                            artDisplay.innerHTML = '<div class="album-art-placeholder">No album art</div>';
                            deleteBtn.style.display = 'none';
                            saveImageBtn.style.display = 'none';
                            applyFolderBtn.style.display = 'none';
                        }
                    }
                    
                    this.setFormEnabled(true);
                    
                    if (listItem.classList.contains('keyboard-focus')) {
                        this.hideStatus();
                    }
                } catch (err) {
                    console.error('Error loading metadata:', err);
                    this.showStatus('Error loading metadata', 'error');
                    this.setFormEnabled(true);
                }
            },
            
            // Filename editing
            cancelFilenameEdit() {
                document.getElementById('current-filename').style.display = 'inline';
                document.querySelector('.filename-edit').style.display = 'none';
            },
            
            resetFilename() {
                document.getElementById('filename-input').value = this.state.originalFilename;
            },
            
            async saveFilename() {
                const button = document.querySelector('.filename-save');
                const newName = document.getElementById('filename-input').value.trim();
                if (!newName || newName === this.state.originalFilename) {
                    this.cancelFilenameEdit();
                    return;
                }
                
                this.setFormEnabled(false);
                this.showButtonStatus(button, 'Renaming...', 'processing');
                
                try {
                    const result = await this.apiCall('/rename', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            oldPath: this.state.currentFile,
                            newName: newName
                        })
                    });
                    
                    if (result.status === 'success') {
                        this.state.currentFile = result.newPath;
                        this.state.originalFilename = newName;
                        document.getElementById('current-filename').textContent = newName;
                        this.cancelFilenameEdit();
                        this.showButtonStatus(button, 'Renamed!', 'success');
                        this.loadFiles(this.state.currentPath);
                    } else {
                        this.showButtonStatus(button, result.error || 'Error', 'error');
                    }
                } catch (err) {
                    console.error('Error renaming file:', err);
                    this.showButtonStatus(button, 'Error', 'error');
                }
                
                this.setFormEnabled(true);
            },
        
            // Album art functions
            handleArtUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.state.pendingAlbumArt = e.target.result;
                    this.state.shouldRemoveArt = false;
                    
                    const artDisplay = document.getElementById('art-display');
                    artDisplay.innerHTML = `<img src="${this.state.pendingAlbumArt}" class="album-art">`;
                    document.querySelector('.delete-art-btn').style.display = 'block';
                    document.querySelector('.save-image-btn').style.display = 'block';
                    document.querySelector('.apply-folder-btn').style.display = 'block';
                    
                    this.showStatus('Image loaded. Click "Save Image" to save only the image, or "Save" to save all changes.', 'success');
                };
                reader.readAsDataURL(file);
                
                event.target.value = '';
            },
        
            deleteAlbumArt() {
                const button = document.querySelector('.delete-art-btn');
                this.state.shouldRemoveArt = true;
                this.state.pendingAlbumArt = null;
                
                const artDisplay = document.getElementById('art-display');
                artDisplay.innerHTML = '<div class="album-art-placeholder">No album art</div>';
                document.querySelector('.delete-art-btn').style.display = 'none';
                document.querySelector('.save-image-btn').style.display = 'none';
                document.querySelector('.apply-folder-btn').style.display = 'none';
                
                this.showButtonStatus(button, 'Marked for deletion', 'warning', 2000);
            },
        
            async saveAlbumArt() {
                if (!this.state.currentFile || !this.state.pendingAlbumArt) return;
                
                const button = document.querySelector('.save-image-btn');
                button.disabled = true;
                this.showButtonStatus(button, 'Saving...', 'processing');
                
                try {
                    const result = await this.apiCall(`/metadata/${encodeURIComponent(this.state.currentFile)}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ art: this.state.pendingAlbumArt })
                    });
                    
                    if (result.status === 'success') {
                        this.showButtonStatus(button, 'Saved!', 'success');
                        this.state.currentAlbumArt = this.state.pendingAlbumArt;
                        this.state.pendingAlbumArt = null;
                        
                        setTimeout(() => {
                            document.querySelector('.save-image-btn').style.display = 'none';
                            document.querySelector('.apply-folder-btn').style.display = 'none';
                        }, 2000);
                    } else {
                        this.showButtonStatus(button, 'Error', 'error');
                    }
                } catch (err) {
                    console.error('Error saving album art:', err);
                    this.showButtonStatus(button, 'Error', 'error');
                }
                
                button.disabled = false;
            },
        
            async applyArtToFolder() {
                if (!this.state.currentFile || (!this.state.pendingAlbumArt && !this.state.currentAlbumArt)) return;
                
                const button = document.querySelector('.apply-folder-btn');
                const artToApply = this.state.pendingAlbumArt || (this.state.currentAlbumArt ? `data:image/jpeg;base64,${this.state.currentAlbumArt}` : null);
                if (!artToApply) {
                    this.showButtonStatus(button, 'No art', 'error', 2000);
                    return;
                }
                
                const folderPath = this.state.currentFile.substring(0, this.state.currentFile.lastIndexOf('/'));
                
                if (!confirm(`Apply this album art to all files in the folder "${folderPath || 'root'}"? This will replace any existing album art.`)) {
                    return;
                }
                
                button.disabled = true;
                this.setFormEnabled(false);
                this.showButtonStatus(button, 'Applying...', 'processing');
                
                try {
                    const result = await this.apiCall('/apply-art-to-folder', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            folderPath: folderPath,
                            art: artToApply
                        })
                    });
                    
                    if (result.status === 'success') {
                        this.showButtonStatus(button, `Applied to ${result.filesUpdated} files!`, 'success', 3000);
                        
                        if (this.state.pendingAlbumArt) {
                            this.state.currentAlbumArt = this.state.pendingAlbumArt;
                            this.state.pendingAlbumArt = null;
                            setTimeout(() => {
                                document.querySelector('.save-image-btn').style.display = 'none';
                                document.querySelector('.apply-folder-btn').style.display = 'none';
                            }, 3000);
                        }
                    } else {
                        this.showButtonStatus(button, result.error || 'Error', 'error');
                    }
                } catch (err) {
                    console.error('Error applying album art to folder:', err);
                    this.showButtonStatus(button, 'Error', 'error');
                }
                
                button.disabled = false;
                this.setFormEnabled(true);
            },
        
            async applyFieldToFolder(field) {
                if (!this.state.currentFile) return;
                
                const button = document.querySelector(`.apply-folder-btn-new[data-field="${field}"]`);
                const value = document.getElementById(field).value.trim();
                if (!value && value !== '') return; // Allow empty string to clear field
                
                const folderPath = this.state.currentFile.substring(0, this.state.currentFile.lastIndexOf('/'));
                const fieldLabel = document.querySelector(`label[for="${field}"]`).textContent;
                
                if (!confirm(`Apply "${fieldLabel}" value "${value}" to all files in the folder "${folderPath || 'root'}"?`)) {
                    return;
                }
                
                button.disabled = true;
                this.setFormEnabled(false);
                this.showButtonStatus(button, 'Applying to folder...', 'processing');
                
                try {
                    const result = await this.apiCall('/apply-field-to-folder', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            folderPath: folderPath,
                            field: field,
                            value: value
                        })
                    });
                    
                    if (result.status === 'success') {
                        this.showButtonStatus(button, `Applied to ${result.filesUpdated} files!`, 'success', 3000);
                        this.state.originalMetadata[field] = value;
                        setTimeout(() => {
                            const controls = document.querySelector(`.apply-field-controls[data-field="${field}"]`);
                            controls.classList.remove('visible');
                        }, 1000);
                    } else {
                        this.showButtonStatus(button, result.error || 'Failed to apply to folder', 'error');
                    }
                } catch (err) {
                    console.error(`Error applying ${fieldLabel} to folder:`, err);
                    this.showButtonStatus(button, 'Error applying to folder', 'error');
                }
                
                button.disabled = false;
                this.setFormEnabled(true);
            },
        
            // Update the save method to handle format-specific errors
            async save() {
                if (!this.state.currentFile) return;
                
                const button = document.querySelector('.save-btn');
                const data = {
                    title: document.getElementById('title').value,
                    artist: document.getElementById('artist').value,
                    album: document.getElementById('album').value,
                    albumartist: document.getElementById('albumartist').value,
                    date: document.getElementById('date').value,
                    genre: document.getElementById('genre').value,
                    track: document.getElementById('track').value,
                    disc: document.getElementById('disc').value
                };
                
                if (this.state.pendingAlbumArt) {
                    data.art = this.state.pendingAlbumArt;
                } else if (this.state.shouldRemoveArt) {
                    data.removeArt = true;
                }
                
                this.setFormEnabled(false);
                this.showButtonStatus(button, 'Saving...', 'processing');
                
                try {
                    const result = await this.apiCall(`/metadata/${encodeURIComponent(this.state.currentFile)}`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                    
                    if (result.status === 'success') {
                        this.showButtonStatus(button, 'Saved!', 'success', 3000);
                        
                        Object.keys(data).forEach(key => {
                            if (key !== 'art' && key !== 'removeArt') {
                                this.state.originalMetadata[key] = data[key];
                            }
                        });
                        
                        document.querySelectorAll('.apply-field-controls').forEach(controls => {
                            controls.classList.remove('visible');
                        });
                        
                        if (this.state.pendingAlbumArt) {
                            this.state.currentAlbumArt = this.state.pendingAlbumArt;
                            document.querySelector('.save-image-btn').style.display = 'none';
                            document.querySelector('.apply-folder-btn').style.display = 'none';
                        } else if (this.state.shouldRemoveArt) {
                            this.state.currentAlbumArt = null;
                        }
                        this.state.pendingAlbumArt = null;
                        this.state.shouldRemoveArt = false;
                    } else {
                        this.showButtonStatus(button, 'Error', 'error');
                    }
                } catch (err) {
                    console.error('Error saving metadata:', err);
                    // Check for specific format-related errors
                    const errorMessage = err.message || '';
                    if (errorMessage.includes('Album art is not supported')) {
                        this.showButtonStatus(button, 'Album art not supported for this format', 'error', 5000);
                    } else {
                        this.showButtonStatus(button, 'Error', 'error');
                    }
                }
                
                this.setFormEnabled(true);
            },

            getFormatEmoji(filename) {
                const ext = filename.split('.').pop().toLowerCase();
                const FORMAT_EMOJIS = {
                    'mp3': '🎵',
                    'flac': '💿',
                    'm4a': '🎶',
                    'wav': '🌊',
                    'wma': '🪟',
                    'wv': '📦',
                };
                return FORMAT_EMOJIS[ext] || '🎵';
            },

            // Add visual indicators for file format support
            getFormatBadge(filename) {
                const ext = filename.split('.').pop().toUpperCase();
                const lossless = ['FLAC', 'WAV', 'WV'];
                const limitedMetadata = ['WAV', 'WV'];
                const noAlbumArt = ['WAV', 'WV'];
                
                const isLossless = lossless.includes(ext);
                const hasLimitations = limitedMetadata.includes(ext) || noAlbumArt.includes(ext);
                
                let badgeHtml = `<span style="
                    font-size: 0.7rem;
                    padding: 0.2rem 0.4rem;
                    border-radius: 4px;
                    background: ${isLossless ? 'rgba(74, 222, 128, 0.2)' : 'rgba(255, 169, 77, 0.2)'};
                    color: ${isLossless ? '#4ade80' : '#ffa94d'};
                    margin-left: 0.5rem;
                    font-weight: 500;
                ">${ext}</span>`;
                
                if (hasLimitations) {
                    const limitations = [];
                    if (limitedMetadata.includes(ext)) {
                        limitations.push('limited metadata');
                    }
                    if (noAlbumArt.includes(ext)) {
                        limitations.push('no album art');
                    }
                    
                    badgeHtml += `<span style="
                        font-size: 0.65rem;
                        padding: 0.15rem 0.3rem;
                        border-radius: 4px;
                        background: rgba(255, 107, 107, 0.2);
                        color: #ff6b6b;
                        margin-left: 0.3rem;
                        font-weight: 400;
                    " title="${limitations.join(', ')}">⚠</span>`;
                }
                
                return badgeHtml;
            },

            async resetForm() {
                if (!this.state.currentFile) return;
                
                const button = document.querySelector('.clear-btn');
                this.showButtonStatus(button, 'Resetting...', 'processing');
                
                try {
                    const data = await this.apiCall(`/metadata/${encodeURIComponent(this.state.currentFile)}`);
                    
                    this.state.originalMetadata = {
                        title: data.title || '',
                        artist: data.artist || '',
                        album: data.album || '',
                        albumartist: data.albumartist || '',
                        date: data.date || '',
                        genre: data.genre || '',
                        track: data.track || '',
                        disc: data.disc || ''
                    };
                    
                    Object.entries(this.state.originalMetadata).forEach(([field, value]) => {
                        document.getElementById(field).value = value;
                    });
                    
                    document.querySelectorAll('.apply-field-controls').forEach(controls => {
                        controls.classList.remove('visible');
                    });
                    
                    this.state.pendingAlbumArt = null;
                    this.state.shouldRemoveArt = false;
                    
                    const artDisplay = document.getElementById('art-display');
                    const deleteBtn = document.querySelector('.delete-art-btn');
                    const saveImageBtn = document.querySelector('.save-image-btn');
                    const applyFolderBtn = document.querySelector('.apply-folder-btn');
                    
                    if (data.hasArt && data.art) {
                        this.state.currentAlbumArt = data.art;
                        artDisplay.innerHTML = `<img src="data:image/jpeg;base64,${data.art}" class="album-art">`;
                        deleteBtn.style.display = 'block';
                        saveImageBtn.style.display = 'none';
                        applyFolderBtn.style.display = 'none';
                    } else {
                        this.state.currentAlbumArt = null;
                        artDisplay.innerHTML = '<div class="album-art-placeholder">No album art</div>';
                        deleteBtn.style.display = 'none';
                        saveImageBtn.style.display = 'none';
                        applyFolderBtn.style.display = 'none';
                    }
                    
                    this.showButtonStatus(button, 'Reset!', 'success', 2000);
                } catch (err) {
                    console.error('Error resetting form:', err);
                    this.showButtonStatus(button, 'Error', 'error');
                }
            },
        
            // Utility functions
            setFormEnabled(enabled) {
                const inputs = document.querySelectorAll('#metadata-form input');
                const buttons = document.querySelectorAll('button');
                
                inputs.forEach(input => input.disabled = !enabled);
                buttons.forEach(button => {
                    if (!button.classList.contains('btn-status') || !button.classList.contains('processing')) {
                        button.disabled = !enabled;
                    }
                });
            },
        
            showStatus(message, type) {
                // Legacy function - kept for compatibility but hidden
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                // Status is now hidden by CSS
            },
        
            hideStatus() {
                // Legacy function - kept for compatibility
                const status = document.getElementById('status');
                status.style.display = 'none';
            }
        };
        
        // Global function bindings for onclick handlers in HTML
        function setSortMethod(method) {
            AudioMetadataEditor.setSortMethod(method);
        }
        
        function saveFilename() {
            AudioMetadataEditor.saveFilename();
        }
        
        function resetFilename() {
            AudioMetadataEditor.resetFilename();
        }
        
        function cancelFilenameEdit() {
            AudioMetadataEditor.cancelFilenameEdit();
        }
        
        function handleArtUpload(event) {
            AudioMetadataEditor.handleArtUpload(event);
        }
        
        function deleteAlbumArt() {
            AudioMetadataEditor.deleteAlbumArt();
        }
        
        function saveAlbumArt() {
            AudioMetadataEditor.saveAlbumArt();
        }
        
        function applyArtToFolder() {
            AudioMetadataEditor.applyArtToFolder();
        }
        
        function applyFieldToFolder(field) {
            AudioMetadataEditor.applyFieldToFolder(field);
        }
        
        function saveFieldToFile(field) {
            AudioMetadataEditor.saveFieldToFile(field);
        }
        
        function save() {
            AudioMetadataEditor.save();
        }
        
        function resetForm() {
            AudioMetadataEditor.resetForm();
        }
        
        // Filename edit click handler
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-filename').onclick = function() {
                if (!AudioMetadataEditor.state.currentFile) return;
                
                document.getElementById('current-filename').style.display = 'none';
                document.querySelector('.filename-edit').style.display = 'flex';
                document.getElementById('filename-input').value = AudioMetadataEditor.state.originalFilename;
                document.getElementById('filename-input').focus();
            };
            
            // Initialize the application
            AudioMetadataEditor.init();
        });

        // Filter box on input handler
        const filter_box = document.getElementById('filter-box');
        filter_box.addEventListener('input', (e) => {
          const value = e.target.value.toLowerCase().trim();
          const file_list_li = document.querySelectorAll('#file-list > li');
          for (let i = 0; i < file_list_li.length; i++) {
            const li = file_list_li[i];
            const file_name = li.querySelector('.file-info > div').innerText.toLowerCase();
            // if the filterd value does not match name, hide item
            if (value.length > 0 && !file_name.includes(value)) {
              li.setAttribute("aria-hidden", "true");
            } else {
              li.removeAttribute("aria-hidden");
            }
          }
        });
    </script>
</body>
</html>
